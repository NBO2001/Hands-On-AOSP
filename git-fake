#!/bin/bash

# Configurações
AOSP_DIR="/home/devtitans-2/aosp"
GIT_REPO_DIR="/home/devtitans-2/aosp-git-repo"
REMOTE_REPO="https://github.com/NBO2001/Hands-On-AOSP.git"

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Função para log
log() {
    echo -e "${GREEN}[git-fake]${NC} $1"
}

error() {
    echo -e "${RED}[git-fake ERROR]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[git-fake WARNING]${NC} $1"
}

# Verificar se estamos no diretório AOSP
if [[ ! "$PWD" =~ ^"$AOSP_DIR" ]]; then
    error "Este comando deve ser executado dentro do diretório AOSP: $AOSP_DIR"
    exit 1
fi

# Inicializar repositório git se não existir
init_repo() {
    if [ ! -d "$GIT_REPO_DIR/.git" ]; then
        log "Inicializando repositório git em $GIT_REPO_DIR"
        cd "$GIT_REPO_DIR"
        git init
        git remote add origin "$REMOTE_REPO"
        
        # Criar README inicial
        echo "# AOSP Changes" > README.md
        echo "Este repositório contém apenas as modificações feitas no projeto AOSP." >> README.md
        git add README.md
        git commit -m "Initial commit"
        
        # Tentar fazer fetch do repositório remoto
        git fetch origin 2>/dev/null || warn "Não foi possível fazer fetch do repositório remoto"
    fi
}

# Função para copiar arquivo do AOSP para o repositório git
copy_file_to_repo() {
    local file_path="$1"
    local full_path="$AOSP_DIR/$file_path"
    local repo_path="$GIT_REPO_DIR/$file_path"
    
    if [ ! -f "$full_path" ]; then
        error "Arquivo não encontrado: $full_path"
        return 1
    fi
    
    log "Copiando $file_path para o repositório git"
    
    # Criar diretório se não existir
    mkdir -p "$(dirname "$repo_path")"
    
    # Copiar arquivo
    cp "$full_path" "$repo_path"
    
    return 0
}

# Função para copiar arquivos do repositório git de volta para o AOSP
copy_files_to_aosp() {
    log "Sincronizando arquivos do repositório git para o AOSP"
    
    cd "$GIT_REPO_DIR"
    
    # Encontrar todos os arquivos no repositório git (exceto .git, README.md, etc.)
    find . -type f -not -path "./.git/*" -not -name "README.md" -not -name "git-fake" | while read -r file; do
        # Remover "./" do início
        file_path="${file#./}"
        
        repo_file="$GIT_REPO_DIR/$file_path"
        aosp_file="$AOSP_DIR/$file_path"
        
        if [ -f "$repo_file" ]; then
            log "Copiando $file_path para o AOSP"
            
            # Criar diretório se não existir
            mkdir -p "$(dirname "$aosp_file")"
            
            # Copiar arquivo
            cp "$repo_file" "$aosp_file"
        fi
    done
    
    log "Sincronização completa!"
}

# Processar comandos git
case "$1" in
    "add")
        init_repo
        cd "$GIT_REPO_DIR"
        
        # Se for um arquivo específico
        if [ -n "$2" ] && [ "$2" != "." ] && [ "$2" != "-A" ]; then
            # Remover prefixo do diretório AOSP se existir
            file_path="${2#$AOSP_DIR/}"
            
            if copy_file_to_repo "$file_path"; then
                git add "$file_path"
                log "Arquivo $file_path adicionado ao repositório git"
            else
                exit 1
            fi
        else
            warn "Comando 'add .' ou 'add -A' não suportado. Especifique arquivos individuais."
            exit 1
        fi
        ;;
    
    "commit")
        init_repo
        cd "$GIT_REPO_DIR"
        shift # Remove 'commit' dos argumentos
        git commit "$@"
        ;;
    
    "push")
        init_repo
        cd "$GIT_REPO_DIR"
        shift # Remove 'push' dos argumentos
        git push "$@"
        ;;
    
    "status")
        init_repo
        cd "$GIT_REPO_DIR"
        git status
        ;;
    
    "log")
        init_repo
        cd "$GIT_REPO_DIR"
        shift # Remove 'log' dos argumentos
        git log "$@"
        ;;
    
    "branch")
        init_repo
        cd "$GIT_REPO_DIR"
        shift # Remove 'branch' dos argumentos
        git branch "$@"
        ;;
    
    "checkout")
        init_repo
        cd "$GIT_REPO_DIR"
        shift # Remove 'checkout' dos argumentos
        git checkout "$@"
        ;;
    
    "pull")
        init_repo
        cd "$GIT_REPO_DIR"
        shift # Remove 'pull' dos argumentos
        
        log "Fazendo pull do repositório remoto"
        git pull "$@"
        
        # Após o pull, copiar arquivos para o AOSP
        if [ $? -eq 0 ]; then
            copy_files_to_aosp
        else
            error "Falha no git pull"
        fi
        ;;
    
    "diff")
        init_repo
        cd "$GIT_REPO_DIR"
        shift # Remove 'diff' dos argumentos
        git diff "$@"
        ;;
    
    "remote")
        init_repo
        cd "$GIT_REPO_DIR"
        shift # Remove 'remote' dos argumentos
        git remote "$@"
        ;;
    
    *)
        echo "git-fake - Proxy para comandos git no projeto AOSP"
        echo ""
        echo "Uso: git-fake <comando> [argumentos...]"
        echo ""
        echo "Comandos suportados:"
        echo "  add <arquivo>    - Copia arquivo do AOSP e adiciona ao repositório git"
        echo "  commit           - Faz commit no repositório git"
        echo "  push             - Faz push para o repositório remoto"
        echo "  pull             - Faz pull do repositório remoto e copia arquivos para o AOSP"
        echo "  status           - Mostra status do repositório git"
        echo "  log              - Mostra log do repositório git"
        echo "  branch           - Gerencia branches"
        echo "  checkout         - Muda de branch ou restaura arquivos"
        echo "  diff             - Mostra diferenças"
        echo "  remote           - Gerencia repositórios remotos"
        echo ""
        echo "Exemplo:"
        echo "  git-fake add packages/apps/Settings/src/com/android/settings/password/ScreenLockType.java"
        echo "  git-fake commit -m 'feat: update ScreenLockType.java'"
        echo "  git-fake push origin main"
        ;;
esac